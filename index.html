<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bysykkel Speedrun Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 600px; width: 70%; float: left; }
    #details { width: 30%; float: left; padding: 20px; }
    h2 { font-family: Arial, sans-serif; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #4CAF50; color: white; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="details">
    <h2>Fastest Times Between Selected Stations</h2>
    <p id="selectedStations">Click on two stations to see the fastest time between them.</p>
    <table>
      <thead>
        <tr><th>Start</th><th>End</th><th>Duration (s)</th><th>Date</th></tr>
      </thead>
      <tbody id="fastestTimes">
        <tr><td colspan="4">Select two stations</td></tr>
      </tbody>
    </table>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize the map centered on Oslo
    var map = L.map('map').setView([59.9139, 10.7522], 13);

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Station Data
    var stations = [
      { id: 1, name: 'Stortorvet', lat: 59.9125, lon: 10.7415 },
      { id: 2, name: 'Jernbanetorget', lat: 59.9110, lon: 10.7503 },
      { id: 3, name: 'Nationaltheatret', lat: 59.9142, lon: 10.7313 }
    ];

    // Add station markers to the map
    stations.forEach(function(station) {
      var marker = L.marker([station.lat, station.lon]).addTo(map);
      marker.bindPopup(`<b>${station.name}</b><br><button onclick="selectStation(${station.id})">Select Station</button>`);
    });

    // Variables to store selected stations
    var selectedStartStation = null;
    var selectedEndStation = null;

    // Load the ride data from a local JSON file
    var rideData;
    fetch('rides.json')
      .then(response => response.json())
      .then(data => {
        rideData = data;
      });

    // Function to select a station
    function selectStation(stationId) {
      if (selectedStartStation === null) {
        selectedStartStation = stationId;
        updateSelectedStations();
      } else if (selectedEndStation === null) {
        selectedEndStation = stationId;
        updateSelectedStations();
        showFastestTimes();
      } else {
        // Reset selections if both are already selected
        selectedStartStation = stationId;
        selectedEndStation = null;
        updateSelectedStations();
      }
    }

    // Update UI to show selected stations
    function updateSelectedStations() {
      var startStationName = selectedStartStation !== null ? stations.find(s => s.id === selectedStartStation).name : "None";
      var endStationName = selectedEndStation !== null ? stations.find(s => s.id === selectedEndStation).name : "None";
      document.getElementById("selectedStations").innerHTML = `Start Station: ${startStationName} | End Station: ${endStationName}`;
    }

    // Function to show fastest times between selected stations
    function showFastestTimes() {
      if (selectedStartStation === null || selectedEndStation === null) {
        return;
      }

      // Find station names
      var startStationName = stations.find(s => s.id === selectedStartStation).name;
      var endStationName = stations.find(s => s.id === selectedEndStation).name;

      // Filter ride data for selected start and end stations
      var filteredData = rideData.filter(ride => ride.start_station === startStationName && ride.end_station === endStationName);

      // Sort by duration (ascending) and take top 1 (fastest time)
      var fastestTime = filteredData.sort((a, b) => a.duration - b.duration)[0];

      // Display the fastest time in the details table
      var tableBody = document.getElementById('fastestTimes');
      tableBody.innerHTML = ''; // Clear current rows

      if (fastestTime) {
        var row = `<tr><td>${fastestTime.start_station}</td><td>${fastestTime.end_station}</td><td>${fastestTime.duration}</td><td>${fastestTime.date}</td></tr>`;
        tableBody.innerHTML += row;
      } else {
        tableBody.innerHTML = '<tr><td colspan="4">No trips found between selected stations</td></tr>';
      }
    }
  </script>
</body>
</html>
